#!/usr/bin/make -f
# Sample debian/rules that uses debhelper.
# GNU copyright 1997 to 1999 by Joey Hess.

export DEB_BUILD_MAINT_OPTIONS = hardening=+all
DPKG_EXPORT_BUILDFLAGS = 1

export DEB_CFLAGS_MAINT_APPEND = -fno-strict-aliasing -fno-delete-null-pointer-checks -DNO_VERSION_DATE -DDIG_SIGCHASE

export DPKG_GENSYMBOLS_CHECK_LEVEL := 4

include /usr/share/dpkg/default.mk

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

COMMA = ,
ifneq (,$(filter parallel=%,$(subst $(COMMA), ,$(DEB_BUILD_OPTIONS))))
  NJOBS := -j $(subst parallel=,,$(filter parallel=%,$(subst $(COMMA), ,$(DEB_BUILD_OPTIONS))))
endif

export arch = $(DEB_HOST_ARCH)

ifeq ($(DEB_HOST_ARCH_OS),kfreebsd)
EXTRA_FEATURES=--disable-linux-caps
endif

%:
	dh $@ --with autotools-dev,systemd,autoreconf --parallel --exclude=.la --fail-missing

override_dh_auto_configure:
	dh_auto_configure -B build -- \
		--libdir=/usr/lib/$(DEB_HOST_MULTIARCH) \
		--sysconfdir=/etc/bind \
		--with-python=python3 \
		--localstatedir=/ \
		--enable-threads \
		--enable-largefile \
		--with-libtool \
		--enable-shared \
		--enable-static \
		--with-gost=no \
		--with-openssl=/usr \
		--with-gssapi=/usr \
		--with-libjson=/usr \
		--with-gnu-ld \
		--with-geoip=/usr \
		--with-atf=no \
		--enable-ipv6 \
		--enable-rrl \
		--enable-filter-aaaa \
		--enable-native-pkcs11 \
		--with-pkcs11=\$${prefix}/lib/softhsm/libsofthsm2.so \
		--with-randomdev=/dev/urandom \
		$(EXTRA_FEATURES)
	dh_auto_configure -B build-udeb -- \
		--sysconfdir=/etc/bind \
		--with-python=python3 \
		--localstatedir=/ \
		--disable-epoll \
		--disable-kqueue \
		--disable-devpoll \
		--disable-threads \
		--disable-linux-caps \
		--wit-openssl=/usr \
		--without-libxml2 \
		--without-libjson \
		--enable-ipv6 \
		--enable-shared \
		--with-libtool \
		--with-gssapi=no \
		--libdir=/lib/$(DEB_HOST_MULTIARCH) \
		--includedir=/usr/include/bind-export
	sh debian/apply-export-patch
	# no need to build these targets here
	sed -i 's/dnssec-pkcs11//;s/named-pkcs11//' build-udeb/bin/Makefile
	sed -i 's/dns-pkcs11//;s/isc-pkcs11//' build-udeb/lib/Makefile

override_dh_auto_build:
	dh_auto_build -B build
	dh_auto_build -B build-udeb

override_dh_auto_clean:
	dh_auto_clean -B build
	dh_auto_clean -B build-udeb

override_dh_auto_install:
	dh_auto_install -B build      --destdir=$(CURDIR)/debian/tmp
	dh_auto_install -B build-udeb --destdir=$(CURDIR)/debian/tmp-udeb

override_dh_install:
	# TODO: move this to bind9.install
	install -c -o bin -g bin -m 444 debian/db.0 $(CURDIR)/debian/bind9/etc/bind/db.0
	install -c -o bin -g bin -m 444 debian/db.0 $(CURDIR)/debian/bind9/etc/bind/db.255
	install -c -o bin -g bin -m 444 debian/db.empty $(CURDIR)/debian/bind9/etc/bind
	install -c -o bin -g bin -m 444 debian/zones.rfc1918 $(CURDIR)/debian/bind9/etc/bind
	install -c -o bin -g bin -m 444 debian/db.127 $(CURDIR)/debian/bind9/etc/bind
	install -c -o bin -g bin -m 444 debian/db.local $(CURDIR)/debian/bind9/etc/bind
	install -c -o bin -g bin -m 444 debian/db.root $(CURDIR)/debian/bind9/etc/bind
	install -c -o bin -g bin -m 440 debian/named.conf $(CURDIR)/debian/bind9/etc/bind
	install -c -o bin -g bin -m 440 debian/named.conf.local $(CURDIR)/debian/bind9/etc/bind
	install -c -o bin -g bin -m 440 debian/named.conf.default-zones $(CURDIR)/debian/bind9/etc/bind
	install -c -o bin -g bin -m 440 bind.keys $(CURDIR)/debian/bind9/etc/bind
	install -c -o bin -g bin -m 440 debian/named.conf.options debian/bind9/usr/share/bind9/
	install -m 644 -o root -g root debian/apparmor-profile debian/bind9/etc/apparmor.d/usr.sbin.named
	install -m 644 -o root -g root debian/apparmor-profile.local debian/bind9/etc/apparmor.d/local/usr.sbin.named
	install -m 0644 -o root -g root debian/extras/insserv.conf.d/bind9 $(CURDIR)/debian/bind9/etc/insserv.conf.d/

	install debian/ip-up.d debian/bind9/etc/ppp/ip-up.d/bind9
	install debian/ip-down.d debian/bind9/etc/ppp/ip-down.d/bind9
	install debian/ip-up.d debian/bind9/etc/network/if-up.d/bind9
	install debian/ip-down.d debian/bind9/etc/network/if-down.d/bind9
	install -m644 debian/bind9.ufw.profile debian/bind9/etc/ufw/applications.d/bind9

	cp doc/arm/*.html debian/bind9-doc/usr/share/doc/bind9-doc/arm
	dh_install

override_dh_systemd_enable:
	dh_systemd_enable -pbind9 --no-enable --name=bind9-resolvconf bind9-resolvconf.service
	dh_systemd_enable -pbind9 --no-enable --name=bind9-pkcs11 bind9-pkcs11.service
	dh_systemd_enable -pbind9 bind9.service
